# =====================================================================
# KB_SCHEMA.yaml — نسخه 0.1.0
# Schema رسمی بانک دانش چندبازاره برای پروژه PrisonBreaker
# =====================================================================

meta:
  schema_version: "0.1.0"
  description: >
    این سند ساختار رسمی تمام فایل‌های بانک دانش (knowledge_base)
    را مشخص می‌کند. هر فایل YAML در مسیر kb/ باید مطابق این schema
    باشد تا توسط موتورهای تحلیل، کشف الگو، بک‌تست و Cross-Market
    بدون خطا پردازش شود.

# ---------------------------------------------------------------------
# 1. DATASETS – تعریف منابع داده
# ---------------------------------------------------------------------
datasets:
  type: list
  fields:
    - id: string      # مثل: btcusdt_4h_v1
    - symbol: string  # مثل: BTCUSDT
    - market: string  # مثل: BTCUSDT_PERP یا DXY
    - timeframe: string   # "4h", "5m", ...
    - source: list         # ["binance_futures", "coinex_futures"]
    - date_range:
        start: datetime
        end: datetime
    - n_candles: int
    - file_path: string     # مسیر داده‌های فرآوری‌شده (parquet/csv)
  example:
    - id: "btcusdt_4h_core_v1"
      symbol: "BTCUSDT"
      market: "BTCUSDT_PERP"
      timeframe: "4h"
      source: ["binance_futures", "coinex_futures"]
      date_range:
        start: "2023-12-01"
        end: "2025-12-01"
      n_candles: 4380
      file_path: "data/btcusdt_4h_features.parquet"

# ---------------------------------------------------------------------
# 2. FEATURES – تعریف فیچرهای رسمی هر کندل
# ---------------------------------------------------------------------
features:
  type: list
  fields:
    - name: string        # مثل M5_PATH_TREND_RET
    - description: string # توضیح فارسی
    - dtype: string       # float, int, categorical, enum
    - origin_level: string  # "4h" یا "5m" یا "aggregated_5m_to_4h"
    - formula: string       # متن کوتاه از تعریف ریاضی
    - tags: list            # ["volatility", "shape", "microstructure"]
  example:
    - name: "RET_4H"
      description: "بازده کندل 4ساعته"
      dtype: "float"
      origin_level: "4h"
      formula: "close/open - 1"
      tags: ["return"]

# ---------------------------------------------------------------------
# 3. CLUSTERS – خوشه‌بندی رسمی کندل‌ها
# ---------------------------------------------------------------------
clusters:
  type: list
  fields:
    - id: string
    - name: string          # مثل: "BODY_SHAPE_CLUSTER_01"
    - method: string        # kmeans, gmm, hierarchical
    - timeframe: string
    - feature_set: list     # لیست فیچرهای استفاده‌شده
    - n_clusters: int
    - description: string
    - centroid_features: dict
  example:
    - id: "C4H_BODY_01"
      name: "Body Shape Cluster 1"
      method: "kmeans"
      timeframe: "4h"
      feature_set: ["BODY_PCT", "UPPER_WICK_PCT", "LOWER_WICK_PCT"]
      n_clusters: 6
      description: "خوشه کندل‌هایی با بدنه متوسط و سایه بالا سنگین"
      centroid_features:
        BODY_PCT: 0.28
        UPPER_WICK_PCT: 0.51
        LOWER_WICK_PCT: 0.21

# ---------------------------------------------------------------------
# 4. PATTERNS – الگوهای کشف‌شده
# ---------------------------------------------------------------------
patterns:
  type: list
  fields:
    - id: string              # مثل: P4-BEARISH-SEQ-01
    - name: string
    - description: string
    - window_length: int      # 2 تا 11
    - timeframe: string       # 4h یا 5m
    - type: enum              # forward, backward, meta
    - conditions: list        # شرایط الگو
    - target: string          # DIR_4H_NEXT یا RET_BIN
    - dataset_used: string    # id دیتاست
    - status: enum            # exploratory/candidate/active/...
    - tags: list
  condition_format:
    # یک شرط واحد این ساختار را دارد:
    - feature: string         # مثل DIR_4H
      operator: string        # ==, >, <, in, between
      value: any
  example:
    - id: "P4_DOWN_01"
      name: "Three-body bearish exhaustion"
      description: "توالی 4 کندلی با دو بدنه کوچک followed by strong close"
      window_length: 4
      timeframe: "4h"
      type: "forward"
      conditions:
        - { feature: "BODY_PCT", operator: "<", value: 0.2 }
        - { feature: "DIR_4H", operator: "==", value: "RET_UP" }
      target: "DIR_4H_NEXT"
      dataset_used: "btcusdt_4h_core_v1"
      status: "active"
      tags: ["shape", "sequence"]

# ---------------------------------------------------------------------
# 5. TRADING_RULES – قوانین معاملاتی مبتنی بر الگوها
# ---------------------------------------------------------------------
trading_rules:
  type: list
  fields:
    - id: string
    - name: string
    - description: string
    - symbol: string
    - direction: enum         # long, short, filter_only
    - entry:
        pattern_refs: list    # لیست ID الگوها
        extra_conditions: list
    - exit:
        tp_sl:
          tp_multiple: float
          sl_multiple: float
          tstop_n_bars: int
    - risk:
        max_leverage: int
        position_size_factor: float
    - dataset_used: string
    - status: enum
  example:
    - id: "CORE-4H-LONG-01"
      name: "4h long after doji cluster"
      description: "ورود لانگ پس از الگوی دوجی با تأیید مسیر میکرو"
      symbol: "BTCUSDT"
      direction: "long"
      entry:
        pattern_refs: ["P_DOJI_01", "P_MICRO_TREND_UP_02"]
        extra_conditions:
          - { feature: "REGIME_STATE", operator: "in", value: ["MID","LOW"] }
      exit:
        tp_sl:
          tp_multiple: 1.6
          sl_multiple: 0.8
          tstop_n_bars: 4
      risk:
        max_leverage: 10
        position_size_factor: 0.25
      dataset_used: "btcusdt_4h_core_v1"
      status: "candidate"

# ---------------------------------------------------------------------
# 6. RULE_RELATIONS – روابط بین قوانین/الگوها
# ---------------------------------------------------------------------
rule_relations:
  type: list
  fields:
    - id: string
    - type: enum    # conflict, confirm, complement
    - rule_a: string
    - rule_b: string
    - evidence:
        backtests: list
        logical_reasoning: string
  example:
    - id: "REL-P4-P3-01"
      type: "conflict"
      rule_a: "RULE-4H-P4-DOWN-AGGR-01"
      rule_b: "RULE-4H-P3-UP-01"
      evidence:
        backtests: ["bt_4h_rules_v020_2025Q2Q4"]
        logical_reasoning: "رفتار الگوهای P4 و P3 در دوره‌های vol بالا متضاد است."

# ---------------------------------------------------------------------
# 7. CROSS_MARKET_PATTERNS – الگوهای مشترک بین بازارها
# ---------------------------------------------------------------------
cross_market_patterns:
  type: list
  fields:
    - id: string
    - markets: list
    - description: string
    - conditions:
        - market: string
          feature: string
          operator: string
          value: any
    - target_market: string
    - target_prediction: string
    - status: enum
  example:
    - id: "XMP-BTC-DXY-01"
      markets: ["BTCUSDT_PERP", "DXY"]
      description: "کاهش BTC پس از فعال‌شدن رژیم ریسک‌گریزی در DXY"
      conditions:
        - { market: "DXY", feature: "REGIME_STATE", operator: "==", value: "RISK_OFF" }
        - { market: "BTCUSDT_PERP", feature: "DIR_4H", operator: "==", value: "RET_UP" }
      target_market: "BTCUSDT_PERP"
      target_prediction: "DIR_4H_NEXT = RET_DOWN"
      status: "exploratory"

# ---------------------------------------------------------------------
# 8. MARKET_RELATIONS – روابط آماری و رگرسیونی بین بازارها
# ---------------------------------------------------------------------
market_relations:
  type: list
  fields:
    - id: string
    - base_market: string
    - other_market: string
    - timeframe: string
    - lead_lag:
        best_lag_other_leads_base: int
        corr_at_best_lag: float
        p_value: float
    - indicators:
        rolling_corr_mean: float
        rolling_corr_std: float
        granger_p_value: float
    - notes: list
  example:
    - id: "REL-BTC-DXY-4H"
      base_market: "BTCUSDT_PERP"
      other_market: "DXY"
      timeframe: "4h"
      lead_lag:
        best_lag_other_leads_base: -2
        corr_at_best_lag: 0.35
        p_value: 0.01
      indicators:
        rolling_corr_mean: -0.22
        rolling_corr_std: 0.14
        granger_p_value: 0.03
      notes:
        - "DXY معمولاً 2 کندل جلوتر از BTC حرکت می‌کند."

# ---------------------------------------------------------------------
# 9. BACKTESTS – نتایج بک‌تست
# ---------------------------------------------------------------------
backtests:
  type: list
  fields:
    - id: string
    - rule_id: string
    - date_range:
        start: datetime
        end: datetime
    - metrics:
        trades: int
        win_rate: float
        avg_r_multiple: float
        max_drawdown: float
        sharpe_like: float
        expected_value: float
    - equity_curve_path: string
    - parameters_used: dict
  example:
    - id: "bt_core4h_rule01_2025Q2Q4"
      rule_id: "CORE-4H-LONG-01"
      date_range:
        start: "2025-03-01"
        end: "2025-09-01"
      metrics:
        trades: 42
        win_rate: 0.64
        avg_r_multiple: 0.45
        max_drawdown: -0.12
        sharpe_like: 1.8
        expected_value: 0.28
      equity_curve_path: "backtests/equity_curves/bt_core4h_rule01_2025Q2Q4.csv"

# ---------------------------------------------------------------------
# 10. PERFORMANCE_OVER_TIME – عملکرد الگوها در پنجره‌های جدا
# ---------------------------------------------------------------------
performance_over_time:
  type: list
  fields:
    - pattern_id: string
    - window_id: string
    - window_range:
        start: datetime
        end: datetime
    - stats:
        trades: int
        win_rate: float
        avg_r: float
        ev: float
        sample_weight: float
  example:
    - pattern_id: "P4_DOWN_01"
      window_id: "2025Q1"
      window_range:
        start: "2025-01-01"
        end: "2025-03-31"
      stats:
        trades: 15
        win_rate: 0.67
        avg_r: 0.38
        ev: 0.24
        sample_weight: 1.5

# ---------------------------------------------------------------------
# 11. STATUS_HISTORY – تاریخچه تغییر وضعیت الگوها
# ---------------------------------------------------------------------
status_history:
  type: list
  fields:
    - pattern_id: string
    - date: datetime
    - old_status: string
    - new_status: string
    - reason: string
    - backtest_refs: list
  example:
    - pattern_id: "P4_DOWN_01"
      date: "2025-09-01"
      old_status: "candidate"
      new_status: "active"
      reason: "عملکرد پایدار در سه پنجره اخیر"
      backtest_refs: ["bt_core4h_rule01_2025Q2Q4"]

# =====================================================================
# پایان KB_SCHEMA.yaml نسخه 0.1.0
# =====================================================================
