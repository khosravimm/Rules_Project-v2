# PrisonBreaker – Ideal State Document (FA)
meta:
  version: "v1.0.0"
  date: "2025-12-06"
  author: "Analyst (ChatGPT)"
  source: "PrisonBreaker/Rules_Project-v2"

## 1) مقدمه
این سند وضعیت ایده‌آل (Ideal State) پروژه PrisonBreaker را توصیف می‌کند؛  
یعنی همان حالت نهایی که سیستم باید به آن برسد تا بتواند:

- بهترین پیش‌بینی جهت کندل بعدی در تایم‌فریم ۴ ساعته  
- با استفاده از ریزساختار ۵ دقیقه‌ای  
- و با تکیه بر الگوهای آماری، ریاضی، ML و AI  

به دست آورد.

این سند مرجع رسمی برای مقایسه با وضعیت فعلی پروژه است (Status / Gap Analysis).

---

## 2) Data Pipeline – لودر و پایپ‌لاین داده

### هدف کلان
ساخت پایپ‌لاینی با کیفیت بالا که:

- دادهٔ ۲ سال کامل فیوچرز BTCUSDT را تقریباً بدون خطا پوشش دهد  
- بازارهای مؤثر بر بیت‌کوین (۵ تا ۱۰ بازار) را تحلیل کند  
- روابط بین بازارهای پیشرو و BTC را شناسایی و به الگوها تزریق کند  
- امکان کشف روابط جدید در آینده را داشته باشد  

### اصول
- هیچ کندلی بی‌ارزش نیست.  
- دادهٔ اصلی یک‌بار برای ۲ سال استخراج می‌شود و پس از آن به صورت افزایشی (incremental) به‌روزرسانی می‌شود.  
- مکانیزم‌های خطا و مانیتورینگ باید رفتار غیرعادی دیتا را تشخیص دهند.

### ویژگی‌های مطلوب
- پشتیبانی از حداقل ۱۰ بازار مرتبط با BTC.  
- حذف کندل‌های ناقص و داده‌های مخدوش.  
- ثبت لاگ، هشدار API، هشدار گسست داده.  
- خروجی یکپارچه (Parquet) با schema ثابت در فولدر data/.

---

## 3) Feature Engineering – استخراج ویژگی‌ها

### 3.1 تایم‌فریم ۵ دقیقه (L1 – Micro)
- ریزساختار:
  - Body%, Shadow%, ATR، Volume Delta  
  - برچسب‌های micro-regime (Impulse/Correction/Range)  
  - rolling windows (1h / 4h) روی داده ۵ دقیقه‌ای  
- هدف: استخراج الگوهایی که درون هر ۴h روی جهت و رفتار کندل اثر می‌گذارند.

### 3.2 تایم‌فریم ۴ ساعت (L2 Mapping + Raw Features)
- ترکیب ۴۸ کندل ۵m در یک ۴h.  
- ساخت بلوک‌های رفتاری (Impulse Block, Exhaustion, Spike Clusters).  
- استخراج:
  - dominant direction  
  - up/down counts  
  - volatility regime  
  - internal pattern labels  
- خروجی ۴h = ترکیب ویژگی‌های OHLC + خروجی L2 Mapping.

---

## 4) Pattern Discovery – کشف الگوها

### 4.1 L1 – الگوهای ۵ دقیقه
- انواع:
  - sequence  
  - feature-based  
  - bayesian  
  - indirect/multi-step  
- دامنه دنباله‌ها: ۲ تا ۱۱ کندل.  
- معیار الگوی معتبر:
  - support ≥ ۵۰  
  - lift ≥ ۱.۱۵  
  - stability ≥ ۰.۲۰ (برحسب پایداری در بخش‌های مختلف دوره زمانی).

### 4.2 L2 – نگاشت 5m → 4h
- کاهش پیچیدگی توالی ۴۸ کندل ۵m.  
- ساخت بلوک‌های آماری + الگوهای داخلی.  
- خروجی: برچسب‌هایی که قدرت توضیحی نسبت به جهت ۴h دارند.

### 4.3 L3 – الگوهای ۴h
- هدف:
  - ۱۰ تا ۱۵ الگوی strong  
  - ۲۰ تا ۳۰ الگوی medium  
- معیارها:
  - strong:
    - support ≥ ۳۰–۵۰  
    - lift ≥ ۱.۲–۱.۳  
  - medium:
    - support ≥ ۲۰  
    - lift ≥ ۱.۱  
  - weak:
    - candidate برای تحقیق بیشتر.

---

## 5) Evaluator – سیستم ارزیابی

### معیارها
- support  
- lift  
- win_rate  
- avg_return  
- توزیع بازده (ریسک/بازده)

### baseline
- baseline جهت = نسبت UP در کل دوره ۴h.  
- baseline بازده = میانگین |RET| در کل دوره.

### تست سلامت
- چک null/NaN در فیچرها.  
- چک support=0.  
- چک توزیع غیرعادی در نتایج.  
- regression test: تغییرات ناگهانی عملکرد پس از ویرایش قواعد.

### مانیتورینگ
- داشبورد ساده که:
  - آخرین support/lift الگوهای اصلی  
  - وضعیت فعال/غیرفعال بودن الگوها  
  را نمایش دهد.

---

## 6) KB – دانش پایه

### ساختار
- یک منبع Canonical واحد برای تعریف الگوها (مثلاً: kb/rules_patterns_master.yaml).  
- سایر فایل‌ها view یا مشتق از منبع اصلی (performance، layers، system).

### امکانات
- نسخه‌گذاری خودکار با meta.version و meta.updated_at.  
- changelog برای هر به‌روزرسانی مهم.  
- schema ثابت در تمام فایل‌های دانش.

### محتوا
- ثبت:
  - الگوهای 5m (L1)  
  - الگوهای L2 (5m→4h)  
  - الگوهای 4h (L3) در سطح strong/medium/weak  
- metadata اصلی:
  - id  
  - name  
  - timeframe  
  - origin_layer  
  - pattern_type  
  - support, lift, stability  
  - tags (regime, sequence-length, strength)  
  - status (active, experimental, deprecated)  
  - last_evaluated_at

### Rulebook
- تولید خودکار توضیح انسان‌خوان برای هر pattern.  
- شامل:
  - شرایط فعال شدن الگو  
  - انتظار جهت و رفتار کندل بعدی  
  - کاربرد عملی در استراتژی ترید.

---

## 7) Documentation

- اسناد رسمی مورد نیاز:
  - Architecture Doc  
  - Discovery Methods (L1/L2/4h/5m)  
  - KB Spec  
  - Evaluator Spec  
  - Rulebook / Trading Guide  
- زبان:
  - فارسی + انگلیسی (هر دو کامل و دقیق).  
- نسخه‌دهی:
  - meta.version و meta.updated_at در ابتدای هر سند  
  - ثبت لینک اسناد در MASTER_KNOWLEDGE.yaml.

---

## 8) Trading Logic – تبدیل الگوها به سیگنال

- قوانین ورود:
  - فعال شدن الگوی strong در 4h  
  - تأیید توسط L2 (5m→4h)  
  - عدم تضاد با L1 micro-patterns.  
- قوانین خروج:
  - TP/SL مبتنی بر ATR  
  - خروج زمان‌محور (بعد از N کندل)  
- invalidation:
  - اگر رفتار کندل‌های بعدی خلاف انتظار pattern باشد، الگو برای بازبینی/تعلیق علامت‌گذاری شود.  
- ریسک‌پذیری:
  - شروع با ریسک پایین (۰.۵–۱٪ در هر معامله).  
- هدف نهایی:
  - win_rate بالاتر از baseline  
  - سود خالص مثبت و پایدار در بک‌تست‌های طولانی‌مدت.

---

## 9) Learning Loop – چرخه یادگیری پویا

- اجرای Miner (L1/L2):
  - هفتگی.  
- اجرای Evaluator:
  - حداقل روزانه یا به ازای هر آپدیت داده.  
- رفتار با الگوهای weak:
  - حذف نمی‌شوند؛ به عنوان candidate نگه‌داری شده و در چرخه‌های بعدی دوباره بررسی می‌شوند.  
- به‌روزرسانی KB:
  - هر دور Miner → نسخه جدید KB (vX.Y.Z)  
  - ثبت changelog: الگوهای جدید، الگوهای تقویت‌شده، الگوهای تضعیف‌شده.

---

## 10) KPIs – معیارهای موفقیت

- support ≥ ۳۰–۵۰ برای الگوهای strong در 4h.  
- lift ≥ ۱.۲–۱.۳ برای strong.  
- win_rate ≥ ۶۰٪ برای جهت کندل بعدی، بعد از فیلترهای کیفی.  
- تعداد الگوهای strong 4h ≥ ۱۰.  
- پایداری نتایج در چند دوره زمانی متفاوت (عدم فروپاشی).  
- نبود تضاد شدید بین L1/L2/L3 در جهت سیگنال‌دهی.

---

## 11) Constraints – محدودیت‌ها

- زمان:
  - نیاز است که هستهٔ عملیاتی اولیه ظرف حدود یک هفته به نقطه قابل استفاده برسد (حداقل برای 4h).  
- منابع:
  - سخت‌افزار محدود (CPU/GPU متوسط).  
- داده:
  - نیاز به دست‌کم ۲ سال داده پایدار برای 5m و 4h.  
- توسعه:
  - سرعت توسعه بالا → نیاز به معماری و اسناد پایدار برای جلوگیری از هرج‌ومرج.

