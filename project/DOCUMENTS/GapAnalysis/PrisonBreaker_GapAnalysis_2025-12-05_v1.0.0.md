# PrisonBreaker Gap Analysis & Roadmap Report

meta:
  version: "v1.0.0"
  date: "2025-12-05"
  author: "Codex Agent"
  source: "PrisonBreaker/Rules_Project-v2"

## Executive Summary
- پایپ‌لاین داده و غنی‌سازی ۴ساعته عملیاتی است، اما ارزیابی الگوهای ۴h پشتیبانی صفر دارد و فیچرهای مورد نیاز (مانند CLOSE_POSITION_LAST) کامل نیستند.
- ساختار KB به‌روز شده (MASTER_KNOWLEDGE، DOCS، ایندکس و فایل‌های ساختاری)، ولی دوگانگی منبع الگوها (kb/rules_4h_patterns.yaml در برابر project/KNOWLEDGE_BASE/patterns/patterns.yaml) و نبود فایل‌های لایه/سیستم ریسک سازگاری ایجاد می‌کند.
- مسیر 5m در غنی‌سازی و ارزیاب پیاده نشده و هیچ الگوی رسمی 5m ثبت نشده است.
- برای رسیدن به حالت ایده‌آل، لازم است الگوهای ۴h بازبینی و هم‌تراز شوند، فیچرهای مفقود محاسبه شوند، مسیر 5m طراحی و اجرا گردد، و KB یکپارچه و نسخه‌مند شود.

## Comparison Table (Current vs Ideal vs Gap)

| محور | وضعیت فعلی | وضعیت ایده‌آل | شکاف |
| --- | --- | --- | --- |
| Data Pipeline | لودر کاننیکال `load_ohlcv` + پارکت‌های 4h؛ حذف کندل ناقص | پایپ‌لاین چندبازاره با پایش خودکار، هشدار خطا، تست انتها-به-انتها | پوشش صرفاً BTCUSDT؛ نبود مانیتورینگ و چندبازاره |
| Feature Eng (4h) | غنی‌سازی ۴h کامل (بدنه، سایه، رولینگ، DIR/RET NEXT) | فیچرهای کامل شامل CLOSE_POSITION_LAST و مسیر 5m | فیچرهای مفقود + عدم پوشش 5m |
| Pattern Mining 4h | YAML الگوها v1.0؛ performance با support=0 | الگوهای قابل‌حمایت با شرط‌های واقع‌بینانه و پشتیبانی>حداقل | شروط سخت/ناسازگار؛ پشتیبانی صفر |
| Pattern Mining 5m | ناموجود | تعریف و ارزیابی الگوهای 5m با غنی‌سازی اختصاصی | مسیر کامل 5m خالی |
| Evaluator | جهت‌محور با expected_direction؛ خروجی پارکت/YAML | ارزیاب پایدار با پشتیبانی>0، آزمون‌های سلامت و CI | بدون پشتیبانی؛ نبود تست و مانیتور |
| KB Structure | MASTER به‌روز + DOCS؛ فایل ساختاری patterns.yaml؛ نبود layers/system | KB یکپارچه، منبع کاننیکال واحد، لایه/سیستم مستند | دوگانگی منبع الگو؛ اسکلت ناقص |
| Documentation | DISCOVERY_METHODS 4h (FA/EN) موجود؛ گزارش وضعیت | اسناد 5m و به‌روزرسانی منظم بر اساس تغییرات | بدون اسناد 5m؛ همگام‌سازی ناقص |

## Technical Gaps
- پشتیبانی صفر برای الگوهای ۴h به‌دلیل شروط سخت/فیچر مفقود (CLOSE_POSITION_LAST) و احتمالاً بازهٔ داده محدود.
- نبود مسیر غنی‌سازی و ارزیابی 5m؛ عدم ثبت الگوهای 5m در KB.
- دوگانگی منابع الگو (`kb/rules_4h_patterns.yaml` vs `project/KNOWLEDGE_BASE/patterns/patterns.yaml`) و نبود منبع کاننیکال واحد.
- فایل‌های لایه/سیستم در `project/KNOWLEDGE_BASE` خالی؛ ساختار KB ناقص.
- عدم تست/مانیتورینگ اتوماتیک برای پایپ‌لاین داده، غنی‌سازی و ارزیاب.

## Risk Quantification Matrix

| ریسک | احتمال | تاثیر | سطح ریسک | نشانه‌ها |
| --- | --- | --- | --- | --- |
| پشتیبانی صفر الگوهای ۴h | بالا | بالا | بالا | status_hint=too_rare، win_rate محاسبه نمی‌شود |
| فیچر مفقود (CLOSE_POSITION_LAST) | متوسط | متوسط | متوسط | شروط YAML برآورده نمی‌شود |
| دوگانگی منبع الگو | متوسط | بالا | بالا | ناهمخوانی ID/نسخه بین دو فایل |
| نبود مسیر 5m | بالا | متوسط | بالا | هیچ الگوی 5m ثبت نشده؛ ارزیاب ندارد |
| نبود تست/CI برای ارزیاب | متوسط | متوسط | متوسط | خطاهای پنهان بدون هشدار |

## Actionable Roadmap

**فاز ۱ (کوتاه‌مدت، 1-2 هفته)**
- بازبینی شروط الگوهای ۴h و ساده‌سازی آستانه‌ها؛ محاسبه CLOSE_POSITION_LAST یا حذف شرط آن. پذیرش: حداقل یک الگو با support ≥ min_support.
- هم‌ترازسازی منابع الگو: تعیین کاننیکال (`kb/rules_4h_patterns.yaml`)، همگام‌سازی `patterns.yaml` با همان ID و افزودن changelog. پذیرش: عدم دوگانگی ID/نسخه.
- افزودن اسکلت `project/KNOWLEDGE_BASE/layers/` و `system/` با متای پایه. پذیرش: YAML معتبر با meta/version.

**فاز ۲ (میان‌مدت، 2-4 هفته)**
- طراحی و پیاده‌سازی غنی‌سازی 5m؛ تعریف حداقل ۳ الگوی 5m و ارزیاب مربوطه. پذیرش: اجرای موفق ارزیاب 5m با خروجی stats/YAML و حداقل یک الگو با support>0.
- افزودن تست‌های سلامت برای غنی‌سازی و ارزیاب (4h/5m) در CI. پذیرش: اجرای موفق تست‌ها در CI/لوکال.
- مستندسازی به‌روزرسانی‌ها در DOCS و MASTER_KNOWLEDGE (نسخه جدید).

**فاز ۳ (بلندمدت، 4-8 هفته)**
- گسترش چندبازاره و مانیتورینگ: پشتیبانی بازارهای دیگر در لودر/ارزیاب، هشدار خطا و پایش پایداری. پذیرش: شاخص‌های مانیتورینگ فعال، خطاهای کلیدی پوشش داده شده.
- بهبود کیفیت الگوها: اعمال روش‌های آماری/ML برای پیشنهاد شروط بهتر و کنترل چندآزمونی. پذیرش: افزایش lift و support در الگوهای منتخب، مستندسازی در KB.

## Dependencies & Blockers
- نیاز به محاسبه فیچرهای مورد اشاره در شروط (CLOSE_POSITION_LAST).
- مشخص شدن منبع کاننیکال الگوها برای جلوگیری از تعارض.
- دسترسی به دادهٔ کافی برای الگوهای 4h/5m پس از بازنگری شروط.

## KPIs & Acceptance Metrics
- حداقل یک الگوی ۴h با support ≥ min_support و win_rate بالاتر از baseline.
- حداقل سه الگوی 5m ثبت‌شده با خروجی ارزیاب (support>0).
- عدم وجود ID تکراری و منبع الگوی واحد در KB.
- اجرای موفق تست‌های سلامت غنی‌سازی/ارزیاب در CI.
- به‌روزرسانی MASTER_KNOWLEDGE و DOCS با نسخه و تایم‌استمپ جدید پس از هر تغییر عمده.
